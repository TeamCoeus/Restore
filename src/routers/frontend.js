const express = require('express');
const router = new express.Router();
const mongoose = require("mongoose");
const jwt = require('jsonwebtoken');

const Config = require("../../config.json");
const Auth = require("../middleware/auth");
const User = require("../db/models/user");

router.get("/auth/login", async(req, res) => {
  try {
    //Get token from cookie
    const token = req.cookies.token || undefined;
    if (!token) { res.render("auth/login") }
    else {
      //Validate and get user
      const decodedToken = jwt.verify(token, Config.web.token_secret);
      const user = await User.findOne({_id: decodedToken._id, 'tokens.token': token });
      if (!user) { res.render("auth/login") }
      else { res.redirect("/dash/home") }
    }
  } catch (error) {
    res.status(500).send({error: true, data: error.message});
  }
});

router.get("/dash", Auth.cookie, async(req, res) => {
  try {
    res.redirect("/dash/home");
  } catch (error) {
    res.status(500).send({error: true, data: error.message});
  }
});

router.get("/dash/home", Auth.cookie, async(req, res) => {
  try {
    res.render("dash/home", {
      user_first_name: req.user.first_name,
      user_last_name: req.user.last_name,
      user_email: req.user.email,
      user_role: req.user.job_title,
      user_profile_url: "data:image/jpeg;base64,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"
    });
  } catch (error) {
    res.status(500).send({error: true, data: error.message});
  }
});

module.exports = router;
